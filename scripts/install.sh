#!/bin/bash

# ===============================================
# üöÄ REMNAWAVE BEDOLAGA BOT - –ê–í–¢–û–£–°–¢–ê–ù–û–í–©–ò–ö
# ===============================================
# –í–µ—Ä—Å–∏—è: 1.2.0
# –ê–≤—Ç–æ—Ä: Bedolaga Team
# GitHub: https://github.com/BEDOLAGA-DEV/remnawave-bedolaga-telegram-bot
# 
# –ò–∑–º–µ–Ω–µ–Ω–∏—è v1.2.0:
# - –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Ñ–∞–π–ª—ã)
# - Firewall –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ eGames —Å REMNAWAVE_SECRET_KEY
# - –£–ª—É—á—à–µ–Ω–Ω–∞—è standalone —É—Å—Ç–∞–Ω–æ–≤–∫–∞
# ===============================================

set -e

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# URL —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –±–æ—Ç–∞
REPO_URL="https://github.com/BEDOLAGA-DEV/remnawave-bedolaga-telegram-bot.git"

# ===============================================
# –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ú–û–î–£–õ–ï–ô
# ===============================================

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –º–æ–¥—É–ª–µ–π
if [ ! -d "$SCRIPT_DIR/lib" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –º–æ–¥—É–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $SCRIPT_DIR/lib"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —Å–∫–∞—á–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é."
    exit 1
fi

# –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π
MODULES=(
    "utils.sh"
    "packages.sh"
    "interactive.sh"
    "docker_setup.sh"
    "env_config.sh"
    "nginx_setup.sh"
    "final.sh"
)

# –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥—É–ª–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
for module in "${MODULES[@]}"; do
    if [ ! -f "$SCRIPT_DIR/lib/$module" ]; then
        echo "‚ùå –ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: $SCRIPT_DIR/lib/$module"
        echo "   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —Å–∫–∞—á–∞–Ω—ã."
        exit 1
    fi
    source "$SCRIPT_DIR/lib/$module" || {
        echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è: $module"
        exit 1
    }
done

# ===============================================
# –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# ===============================================

main() {
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    print_banner
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∏
    check_root
    detect_os
    
    echo -e "${WHITE}–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç Remnawave Bedolaga Telegram Bot${NC}"
    echo -e "${YELLOW}–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å:${NC}"
    echo -e "  - BOT_TOKEN –æ—Ç @BotFather"
    echo -e "  - ADMIN_ID (–≤–∞—à Telegram ID)"
    echo -e "  - REMNAWAVE_API_KEY –∏–∑ –ø–∞–Ω–µ–ª–∏ Remnawave"
    echo -e "  - DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω webhook)"
    echo ""
    
    if ! confirm "–ù–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É?"; then
        echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
        exit 0
    fi
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
    update_system
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
    install_base_packages
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
    install_docker
    
    # –í—ã–±–æ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    select_install_dir
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–ª–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
    check_remnawave_panel
    
    # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    clone_repository
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    create_directories
    
    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
    interactive_setup
    
    # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
    create_env_file
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Mini App
    setup_miniapp_files
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–º–µ–Ω—ã –¥–ª—è webhook/miniapp)
    setup_nginx
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firewall (–û–ü–¶–ò–û–ù–ê–õ–¨–ù–û)
    setup_firewall
    
    # –ó–∞–ø—É—Å–∫ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    start_docker
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    create_management_scripts
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    print_final_info
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
    ask_show_logs
}

# ===============================================
# –ó–ê–ü–£–°–ö
# ===============================================

main "$@"
